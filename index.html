<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>腦血管疾病風險預測與死亡率監控平台</title>
  <style>
    :root{--bg:#f6f8fa;--card:#ffffff;--accent:#1f7fbf;--accent2:#2fb8a6;--muted:#6b7280;--danger:#e06a6a}
    body{font-family: "Noto Sans","Microsoft JhengHei",Arial,sans-serif;background:var(--bg);margin:0;color:#0f1724}
    .container{max-width:1200px;margin:24px auto;padding:18px;}
    header{display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px}
    h1{margin:0;font-size:26px;color:var(--accent)}
    .controls{display:flex;gap:12px;align-items:center}
    .kpi{background:var(--card);padding:12px;border-radius:8px;box-shadow:0 1px 3px rgba(0,0,0,0.06);}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:16px;align-items:start}
    .card{background:var(--card);padding:18px;border-radius:10px;box-shadow:0 6px 18px rgba(15,23,36,0.04)}
    .form-row{display:flex;gap:8px;align-items:center;margin-bottom:10px}
    label{width:90px;font-size:14px;color:var(--muted)}
    input[type=text], input[type=number], select{flex:1;padding:8px;border-radius:6px;border:1px solid #e6e9ee}
    .btn{background:var(--accent);color:white;padding:10px 14px;border-radius:8px;border:none;cursor:pointer}
    .gauge{display:flex;gap:18px;align-items:center}
    .gauge .big{font-size:42px;font-weight:700}
    .bars{margin-top:10px}
    .bar{height:14px;border-radius:8px;background:#ecf3f8;margin:8px 0;overflow:hidden}
    .bar > i{display:block;height:100%;background:linear-gradient(90deg,var(--accent2),var(--accent));}
    .trend svg{width:100%;height:200px}
    footer{margin-top:16px;display:flex;gap:12px;flex-wrap:wrap}
    .note{font-size:13px;color:var(--muted)}
    @media(max-width:920px){.grid{grid-template-columns:1fr}}
     
    /* 儀表盤樣式 - 放大 */
    .gauge-container {
      position: relative;
      width: 320px;
      height: 220px;
      overflow: visible;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .gauge-labels {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }
    .gauge-label {
      position: absolute;
      font-size: 10px;
      color: var(--muted);
      transform: translate(-50%, -50%);
    }
     
    /* BMI值樣式 - 增大字體 */
    #bmiResult {
      font-size: 18px;
      font-weight: bold;
    }
     
    /* 高風險提示文字居中 */
    .risk-warning {
      text-align: center;
      font-size: 13px;
      color: var(--muted);
      margin-top: 6px;
      width: 100%;
    }
    /* Dynamic KPI dashboard style */
    .kpi-dashboard {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .kpi-board {
        background: linear-gradient(135deg, #1f7fbf, #2fb8a6);
        color: white;
        padding: 12px 16px;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        text-align: center;
        min-width: 180px;
        transition: all 0.3s ease-in-out;
    }
    .kpi-board-title {
        font-size: 14px;
        font-weight: 600;
        margin-bottom: 4px;
    }
    .kpi-board-value {
        font-size: 24px;
        font-weight: 800;
        line-height: 1;
    }
    .kpi-board-year {
        font-size: 14px;
        margin-top: 4px;
    }
    .year-select-container {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 4px;
    }
    .year-select-container label {
      font-size: 13px;
      color: var(--muted);
      margin-bottom: -4px;
    }
    .year-select-container select {
      background: var(--card);
      border: 1px solid #e6e9ee;
      padding: 6px 8px;
      border-radius: 8px;
    }
    
    /* 年齡層死亡率分佈圖表樣式 */
    .age-distribution-chart {
      margin-top: 20px;
      padding: 15px;
      background: #f9f9f9;
      border-radius: 8px;
    }
    .chart-container {
      width: 100%;
      height: 400px;
      position: relative;
    }
    .chart-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 15px;
      color: var(--accent);
    }
    .chart-legend {
      display: flex;
      gap: 15px;
      margin-top: 15px;
      flex-wrap: wrap;
    }
    .legend-item {
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 13px;
    }
    .legend-color {
      width: 15px;
      height: 15px;
      border-radius: 3px;
    }
    .axis-label {
      font-size: 12px;
      fill: var(--muted);
    }
    .axis-line {
      stroke: #ddd;
      stroke-width: 1;
    }
    .bar-group {
      transition: opacity 0.3s;
    }
    .bar-group:hover {
      opacity: 0.8;
    }
    .tooltip {
      position: absolute;
      padding: 8px;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      border-radius: 4px;
      font-size: 12px;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.3s;
    }
    
    /* 性别分布样式 */
    .gender-distribution {
      margin-top: 20px;
    }
    .gender-bars {
      display: flex;
      height: 40px;
      margin-top: 10px;
      border-radius: 8px;
      overflow: hidden;
    }
    .male-bar {
      background-color: #1f7fbf;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
    }
    .female-bar {
      background-color: #e06a6a;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
    }
    .gender-labels {
      display: flex;
      justify-content: space-between;
      margin-top: 5px;
      font-size: 12px;
      color: var(--muted);
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h1>腦血管疾病風險預測與死亡率監控平台</h1>
        <div class="note">資料來源：Kaggle Stroke Dataset（個人層級模擬） + MOHW 死因統計（群體層級）</div>
      </div>
      <div class="kpi-dashboard">
        <div class="year-select-container">
            <label for="year-select">選擇年度:</label>
            <select id="year-select"></select>
        </div>
        <div class="kpi-board">
            <div class="kpi-board-title" id="cause-rank-title">腦血管疾病死因排名</div>
            <div class="kpi-board-value" id="cause-rank-value">--</div>
            <div class="kpi-board-year" id="kpi-year">--</div>
        </div>
      </div>
    </header>

    <!-- 個人風險預測 -->
    <div class="grid">
      <div class="card">
        <h3>個人風險預測</h3>
        <p class="note">輸入病人特徵，按「計算風險」會用示範模型計算分數（0–100）。</p>

        <div style="margin-top:8px">
          <div class="form-row"><label>年齡</label><input id="age" type="number" value="65" min="0" max="120" /></div>
          <div class="form-row"><label>性別</label>
            <select id="gender"><option value="male">男</option><option value="female">女</option></select>
          </div>
          <div class="form-row"><label>高血壓</label><select id="htn"><option value="0">否</option><option value="1">是</option></select></div>
          <div class="form-row"><label>心臟病</label><select id="hd"><option value="0">否</option><option value="1">是</option></select></div>
          <div class="form-row"><label>平均血糖</label><input id="glucose" type="number" value="110" /></div>
          <div class="form-row"><label>身高 (cm)</label><input id="heightCm" type="number" value="170" step="1" /></div>
          <div class="form-row"><label>體重 (kg)</label><input id="weightKg" type="number" value="75" step="0.1" /></div>
          <div class="form-row"><label>吸菸狀態</label>
            <select id="smoke_status"><option value="0">從未吸菸</option><option value="0.5">曾吸菸</option><option value="1">吸菸中</option></select>
          </div>
          <div style="margin-top:12px"><button class="btn" onclick="computeRisk()">計算風險</button></div>
        </div>

        <hr style="margin:14px 0" />
         
        <div class="form-row" style="margin-bottom:14px; font-weight:600; font-size:14px">
            <label>BMI 數值</label>
            <span id="bmiResult" style="color:var(--accent); flex:1">--</span>
        </div>

        <div class="gauge">
          <div>
            <div class="big" id="riskText">-- %</div>
            <div class="note">估計中風風險</div>
          </div>
          <div style="flex:1; display: flex; flex-direction: column; align-items: center;">
            <div class="gauge-container">
              <svg id="gaugeSvg" width="320" height="220" viewBox="0 0 320 220"></svg>
              <div class="gauge-labels" id="gaugeLabels"></div>
            </div>
            <div class="risk-warning">高風險提示：紅色區域</div>
          </div>
        </div>

        <div style="margin-top:12px">
          <div class="bars">
            <div style="display:flex;justify-content:space-between"><div class="note">重要影響因子</div><div class="note" id="topFactorsVal">-</div></div>
            <div class="bar"><i id="barAge" style="width:0%"></i></div>
            <div class="bar"><i id="barHtn" style="width:0%"></i></div>
            <div class="bar"><i id="barGlucose" style="width:0%"></i></div>
          </div>
        </div>

        <div id="riskExplain" style="margin-top:12px;font-size:14px;font-weight:600;color:var(--muted)">請輸入資料並計算風險。</div>
      </div>

      <!-- 公共衛生趨勢 -->
      <div class="card">
        <h3>公共衛生趨勢（MOHW 範例資料）</h3>
        <p class="note" id="trend-note">下圖為腦血管疾病死亡率（每十萬人口）及年齡層分佈示範。</p>
        <div class="trend"><svg id="trendSvg" viewBox="0 0 500 200" preserveAspectRatio="none"></svg></div>
        
        <!-- 性别分布图表 -->
        <div class="gender-distribution">
          <div style="font-size:13px;color:var(--muted)">性别死亡率分布 (<span id="gender-dist-year">2023</span>)</div>
          <div class="gender-bars" id="gender-bars">
            <div class="male-bar" id="male-bar" style="width:50%">男性: 50%</div>
            <div class="female-bar" id="female-bar" style="width:50%">女性: 50%</div>
          </div>
          <div class="gender-labels">
            <span id="male-label">男性: --</span>
            <span id="female-label">女性: --</span>
          </div>
        </div>
        
        <div style="margin-top:10px">
          <div style="font-size:13px;color:var(--muted)">年齡層死亡率分佈 (<span id="age-dist-year">2023</span>)</div>
          <div style="display:flex;gap:8px;margin-top:6px">
            <div style="flex:1;background:#ecf8f4;border-radius:8px;padding:8px">
              <div style="height:28px;background:linear-gradient(90deg,var(--accent2),var(--accent));width:0%;border-radius:6px;margin-bottom:6px" id="age-bar-1"></div>
              <div style="height:28px;background:linear-gradient(90deg,var(--accent2),var(--accent));width:0%;border-radius:6px;margin-bottom:6px" id="age-bar-2"></div>
              <div style="height:28px;background:linear-gradient(90deg,var(--accent2),var(--accent));width:0%;border-radius:6px;margin-bottom:6px" id="age-bar-3"></div>
              <div style="height:28px;background:linear-gradient(90deg,var(--accent2),var(--accent));width:0%;border-radius:6px;margin-bottom:6px" id="age-bar-4"></div>
              <div style="height:28px;background:linear-gradient(90deg,var(--accent2),var(--accent));width:0%;border-radius:6px" id="age-bar-5"></div>
            </div>
            <div style="width:100px; display:flex; flex-direction: column; justify-content:space-between;">
              <div style="font-size:13px" id="age-label-1">--</div>
              <div style="font-size:13px" id="age-label-2">--</div>
              <div style="font-size:13px" id="age-label-3">--</div>
              <div style="font-size:13px" id="age-label-4">--</div>
              <div style="font-size:13px" id="age-label-5">--</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 整合分析 -->
    <div class="card" style="margin-top:18px">
      <h3>整合分析</h3>
      <div style="display:flex;flex-wrap:wrap;gap:16px;align-items:center">
        <div style="flex:1;min-width:280px">
          <svg id="featureSvg" viewBox="0 0 500 200" preserveAspectRatio="none"></svg>
        </div>
        <div style="flex:1;min-width:260px;background:#f0fafc;padding:12px;border-radius:8px">
          <p class="note"><b>核心洞見：</b>模型與 MOHW 統計一致顯示：年齡與高血壓是腦血管疾病的主要風險因子。建議醫院針對高齡與慢性病患者加強篩檢與衛教，降低中風發生率。</p>
        </div>
      </div>
    </div>

    <footer>
      <div class="card" style="flex:1">
        <strong>About / 使用說明</strong>
        <p class="note">此 HTML 為完整 Demo：前端互動為模擬計算，並非臨床模型。若要實際應用，請串接後端 API 與真實授權資料。</p>
      </div>
    </footer>
  </div>

  <!-- 工具提示 -->
  <div class="tooltip" id="tooltip"></div>

<script>
  // 使用提供的Excel数据
  const causeData = [
    { year: 2018, '腦血管疾病': 11540 },
    { year: 2019, '腦血管疾病': 11237 },
    { year: 2020, '腦血管疾病': 10967 },
    { year: 2021, '腦血管疾病': 11713 },
    { year: 2022, '腦血管疾病': 11970 },
    { year: 2023, '腦血管疾病': 12371 },
    { year: 2024, '腦血管疾病': 12463 }
  ];

  const populationData = [
    { year: 2018, population: 23403073 },
    { year: 2019, population: 23426637 },
    { year: 2020, population: 23419423 },
    { year: 2021, population: 23314966 },
    { year: 2022, population: 23179516 },
    { year: 2023, population: 23211595 },
    { year: 2024, population: 23279445 }
  ];

  // 性别分布数据
  const genderData = [
    { year: 2015, male: 115289, female: 111421 },
    { year: 2016, male: 126459, female: 118861 },
    { year: 2017, male: 128724, female: 122395 },
    { year: 2018, male: 130705, female: 125565 },
    { year: 2019, male: 135090, female: 129816 },
    { year: 2020, male: 137590, female: 132238 },
    { year: 2021, male: 134493, female: 133280 },
    { year: 2022, male: 148144, female: 138889 },
    { year: 2023, male: 150211, female: 140284 },
    { year: 2024, male: 152369, female: 143755 }
  ];

  // 年龄分布数据
  const ageData = [
    { year: 2015, '1-14': 92, '15-24': 282, '25-44': 12875, '45-64': 67849, '65+': 125739 },
    { year: 2016, '1-14': 138, '15-24': 294, '25-44': 12510, '45-64': 71036, '65+': 141372 },
    { year: 2017, '1-14': 104, '15-24': 259, '25-44': 11505, '45-64': 71198, '65+': 148034 },
    { year: 2018, '1-14': 99, '15-24': 118, '25-44': 11603, '45-64': 70333, '65+': 152264 },
    { year: 2019, '1-14': 27, '15-24': 313, '25-44': 12996, '45-64': 72971, '65+': 169809 },
    { year: 2020, '1-14': 115, '15-24': 220, '25-44': 10996, '45-64': 73370, '65+': 172120 },
    { year: 2021, '1-14': 56, '15-24': 154, '25-44': 10921, '45-64': 70589, '65+': 170681 },
    { year: 2022, '1-14': 82, '15-24': 116, '25-44': 10311, '45-64': 70820, '65+': 200822 },
    { year: 2023, '1-14': 39, '15-24': 96, '25-44': 10812, '45-64': 76762, '65+': 204831 },
    { year: 2024, '1-14': 119, '15-24': 163, '25-44': 9030, '45-64': 77492, '65+': 218151 }
  ];

  // 脑脑血管疾病死因排名数据
  const strokeRankingData = [
    { year: 2018, rank: 4, total_causes: 11520 },
    { year: 2019, rank: 4, total_causes: 12176 },
    { year: 2020, rank: 4, total_causes: 11821 },
    { year: 2021, rank: 4, total_causes: 12182 },
    { year: 2022, rank: 5, total_causes: 12416 },
    { year: 2023, rank: 4, total_causes: 12371 },
    { year: 2024, rank: 4, total_causes: 12463 }
  ];

  const yearSelect = document.getElementById('year-select');
  const causeRankValue = document.getElementById('cause-rank-value');
  const kpiYear = document.getElementById('kpi-year');
  const ageDistYear = document.getElementById('age-dist-year');
  const genderDistYear = document.getElementById('gender-dist-year');
  const tooltip = document.getElementById('tooltip');

  /**
   * Updates the KPI board with the stroke ranking for the selected year.
   * @param {number} year The year to display.
   */
  function updateKpiDashboard(year) {
    const yearData = strokeRankingData.find(item => item.year === parseInt(year, 10));
    const causeDataForYear = causeData.find(item => item.year === parseInt(year, 10));

    if (!yearData || !causeDataForYear) {
      console.error(`No data found for the year: ${year}`);
      causeRankValue.textContent = '--';
      kpiYear.textContent = '--';
      return;
    }

    causeRankValue.textContent = `第${yearData.rank}位 (${causeDataForYear['腦血管疾病'].toLocaleString()}人)`;
    kpiYear.textContent = year;
  }

  function computeRisk(){
    // 取得使用者輸入值
    const age = Number(document.getElementById('age').value) || 0;
    const htn = Number(document.getElementById('htn').value);
    const hd = Number(document.getElementById('hd').value);
    const glucose = Number(document.getElementById('glucose').value) || 100;
    const heightCm = Number(document.getElementById('heightCm').value) || 170;
    const weightKg = Number(document.getElementById('weightKg').value) || 75;
    const smoking_status = Number(document.getElementById('smoke_status').value);

    // 新增：根據身高體重計算 BMI
    let bmi = 0;
    if (heightCm > 0) {
      const heightM = heightCm / 100;
      bmi = weightKg / (heightM * heightM);
    }
    // 將計算出的 BMI 顯示在頁面上
    document.getElementById('bmiResult').innerText = bmi.toFixed(1);
     
    // 根據你的 Logistic Regression 模型結果，調整風險計算權重
    // 這是前端模擬，非實際模型推論，權重僅供參考以符合你的分析結果
    let score = 0;
    let age_factor = age * 0.38; // 年齡是重要因子，賦予較大權重
    let htn_factor = htn * 20;   // 高血壓是重要因子，賦予較大權重
    let hd_factor = hd * 10;     // 心臟病有一定影響
    let glucose_factor = Math.max(0,(glucose-90)) * 0.12; // 高血糖有影響，90以上才算
    let bmi_factor = Math.max(0,(bmi-25)) * 0.5; // BMI超過25才開始影響
    let smoke_factor = smoking_status * 12; // 吸菸狀態有影響

    // 總分計算與正規化
    score = age_factor + htn_factor + hd_factor + glucose_factor + bmi_factor + smoke_factor;
    score = Math.round(Math.max(0, Math.min(100, score)));
    document.getElementById('riskText').innerText = score + " %";
    drawGauge(score);

    // 計算各個因子的貢獻比例，用於繪製下方的條形圖
    const total_factors_sum = Math.max(1, age_factor + htn_factor + glucose_factor);
    const age_con = Math.min(100, Math.round((age_factor/total_factors_sum)*100));
    const htn_con = Math.min(100, Math.round((htn_factor/total_factors_sum)*100));
    const glu_con = Math.min(100, Math.round((glucose_factor/total_factors_sum)*100));

    document.getElementById('barAge').style.width = age_con + "%";
    document.getElementById('barHtn').style.width = htn_con + "%";
    document.getElementById('barGlucose').style.width = glu_con + "%";

    const topFactors = [];
    if(age_con>0) topFactors.push("年齡");
    if(htn_con>0) topFactors.push("高血壓");
    if(glu_con>0) topFactors.push("血糖");
    document.getElementById('topFactorsVal').innerText = topFactors.join(", ");

    const explain = document.getElementById("riskExplain");
    if(score>=70){explain.innerText="⚠️ 高風險，建議立即尋求專業醫療諮詢與管理。";explain.style.color="var(--danger)";}
    else if(score>=40){explain.innerText="⚠️ 中等風險，需加強健康追蹤與生活習慣改善。";explain.style.color="#d97706";}
    else {explain.innerText="✅ 低風險，建議維持健康生活方式並定期檢查。";explain.style.color="green";}
  }

  // 完全重写仪表盘绘制函数
  function drawGauge(value){
    const svg = document.getElementById('gaugeSvg');
    const labelsContainer = document.getElementById('gaugeLabels');
     
    // 清空 SVG 和標籤容器
    while(svg.firstChild) svg.removeChild(svg.firstChild);
    while(labelsContainer.firstChild) labelsContainer.removeChild(labelsContainer.firstChild);
     
    // 設置參數 - 更新為新的尺寸
    const width = 320;
    const height = 220;
    const cx = width / 2;
    const cy = height - 20; // 降低圓心位置
    const radius = 85; // 增加半徑以適應新布局
    const startAngle = Math.PI; // 從左側開始 (180度)
    const endAngle = 0; // 到右側結束 (0度)
     
    // 繪製圓弧背景
    function createArc(startAngle, endAngle, color, width) {
      const start = polarToCartesian(cx, cy, radius, startAngle);
      const end = polarToCartesian(cx, cy, radius, endAngle);
       
      const largeArcFlag = endAngle <= Math.PI ? 0 : 1;
       
      const d = [
        "M", start.x, start.y,
        "A", radius, radius, 0, largeArcFlag, 0, end.x, end.y
      ].join(" ");
       
      const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
      path.setAttribute("d", d);
      path.setAttribute("fill", "none");
      path.setAttribute("stroke", color);
      path.setAttribute("stroke-width", width);
      path.setAttribute("stroke-linecap", "round");
      return path;
    }
     
    // 极座標轉換為笛卡爾座標
    function polarToCartesian(centerX, centerY, radius, angle) {
      return {
        x: centerX + (radius * Math.cos(angle)),
        y: centerY + (radius * Math.sin(angle))
      };
    }
     
    // 繪製三個風險區域的圓弧
    const lowRiskArc = createArc(startAngle, startAngle + (Math.PI * 0.7), "#88e1c7", 16);
    const mediumRiskArc = createArc(startAngle + (Math.PI * 0.7), startAngle + (Math.PI * 0.9), "#ffd78a", 16);
    const highRiskArc = createArc(startAngle + (Math.PI * 0.9), endAngle, "#f08a8a", 16);
     
    svg.appendChild(lowRiskArc);
    svg.appendChild(mediumRiskArc);
    svg.appendChild(highRiskArc);
     
    // 繪製刻度標記
    for (let i = 0; i <= 10; i++) {
      const angle = startAngle + (i / 10) * Math.PI;
      const x1 = cx + (radius - 6) * Math.cos(angle);
      const y1 = cy + (radius - 6) * Math.sin(angle);
      const x2 = cx + (radius + 6) * Math.cos(angle);
      const y2 = cy + (radius + 6) * Math.sin(angle);
       
      const tick = document.createElementNS("http://www.w3.org/2000/svg", "line");
      tick.setAttribute("x1", x1);
      tick.setAttribute("y1", y1);
      tick.setAttribute("x2", x2);
      tick.setAttribute("y2", y2);
      tick.setAttribute("stroke", "#0f1724");
      tick.setAttribute("stroke-width", i % 5 === 0 ? 2 : 1);
      svg.appendChild(tick);
       
      // 每20個單位添加一個標籤
      if (i % 2 === 0) {
        const labelValue = i * 10;
        const labelRadius = radius + 25; // 標籤位置稍微遠離圓弧
        const labelX = cx + labelRadius * Math.cos(angle);
        const labelY = cy + labelRadius * Math.sin(angle);
         
        const label = document.createElement("div");
        label.className = "gauge-label";
        label.textContent = labelValue;
        label.style.left = `${labelX}px`;
        label.style.top = `${labelY}px`;
        labelsContainer.appendChild(label);
      }
    }
     
    // 繪製指針
    const pointerAngle = startAngle + (value / 100) * Math.PI;
    const pointerLength = radius - 18;
    const nx = cx + pointerLength * Math.cos(pointerAngle);
    const ny = cy + pointerLength * Math.sin(pointerAngle);
     
    const pointer = document.createElementNS("http://www.w3.org/2000/svg", "line");
    pointer.setAttribute("x1", cx);
    pointer.setAttribute("y1", cy);
    pointer.setAttribute("x2", nx);
    pointer.setAttribute("y2", ny);
    pointer.setAttribute("stroke", "#0f1724");
    pointer.setAttribute("stroke-width", "3");
    pointer.setAttribute("stroke-linecap", "round");
    svg.appendChild(pointer);
     
    // 繪製中心圓
    const centerCircle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
    centerCircle.setAttribute("cx", cx);
    centerCircle.setAttribute("cy", cy);
    centerCircle.setAttribute("r", "10");
    centerCircle.setAttribute("fill", "#0f1724");
    svg.appendChild(centerCircle);
     
    const centerCircleInner = document.createElementNS("http://www.w3.org/2000/svg", "circle");
    centerCircleInner.setAttribute("cx", cx);
    centerCircleInner.setAttribute("cy", cy);
    centerCircleInner.setAttribute("r", "6");
    centerCircleInner.setAttribute("fill", "white");
    svg.appendChild(centerCircleInner);
  }

  // 更新趨勢圖
  function drawTrend() {
    const deathsData = {};
    causeData.forEach(item => {
      deathsData[item.year] = item['腦血管疾病'];
    });
    
    const populationDataObj = {};
    populationData.forEach(item => {
      populationDataObj[item.year] = item.population;
    });

    const years = Object.keys(deathsData).map(Number).sort((a,b) => a-b);
    const data = years.map(year => {
        if (populationDataObj[year] > 0) {
            return (deathsData[year] / populationDataObj[year]) * 100000;
        }
        return 0;
    });

    const svg = document.getElementById('trendSvg');
    while(svg.firstChild) svg.removeChild(svg.firstChild);
    const w = 500, h = 200, p = 24;
    const min = Math.min(...data), max = Math.max(...data);
    const scaleX = (w - 2 * p) / (data.length - 1);
    const scaleY = (h - 2 * p) / (max - min);

    let pts = "";
    data.forEach((v, i) => {
        const x = p + i * scaleX;
        const y = p + (max - v) * scaleY;
        pts += x + "," + y + " ";
        svg.innerHTML += `<circle cx="${x}" cy="${y}" r="3" fill="${'var(--accent)'}"/>`;
        svg.innerHTML += `<text x="${x}" y="${y - 8}" font-size="10" text-anchor="middle" fill="var(--accent)">${v.toFixed(1)}</text>`;
    });

    svg.innerHTML += `<polyline points="${pts}" fill="none" stroke="${'var(--accent)'}" stroke-width="2"/>`;

    years.forEach((yr, i) => {
        const x = p + i * scaleX;
        svg.innerHTML += `<text x="${x}" y="${h - 6}" font-size="10" text-anchor="middle" fill="var(--muted)">${yr}</text>`;
    });
  }

  // 更新性别分布
  function updateGenderDistribution(year) {
    const yearData = genderData.find(item => item.year === parseInt(year, 10));
    
    if (!yearData) {
      console.error(`No gender data found for the year: ${year}`);
      return;
    }
    
    const total = yearData.male + yearData.female;
    const malePercentage = Math.round((yearData.male / total) * 100);
    const femalePercentage = 100 - malePercentage;
    
    document.getElementById('male-bar').style.width = `${malePercentage}%`;
    document.getElementById('female-bar').style.width = `${femalePercentage}%`;
    document.getElementById('male-bar').textContent = `男性: ${malePercentage}%`;
    document.getElementById('female-bar').textContent = `女性: ${femalePercentage}%`;
    document.getElementById('male-label').textContent = `男性: ${yearData.male.toLocaleString()}人`;
    document.getElementById('female-label').textContent = `女性: ${yearData.female.toLocaleString()}人`;
    genderDistYear.textContent = year;
  }

  // 更新年齡層死亡率分佈
  function updateAgeDistribution(year) {
    const yearData = ageData.find(item => item.year === parseInt(year, 10));
    
    if (!yearData) {
      console.error(`No age data found for the year: ${year}`);
      return;
    }
    
    const totalDeaths = yearData['1-14'] + yearData['15-24'] + yearData['25-44'] + yearData['45-64'] + yearData['65+'];
    
    const percentage1to14 = (yearData['1-14'] / totalDeaths) * 100;
    const percentage15to24 = (yearData['15-24'] / totalDeaths) * 100;
    const percentage25to44 = (yearData['25-44'] / totalDeaths) * 100;
    const percentage45to64 = (yearData['45-64'] / totalDeaths) * 100;
    const percentage65plus = (yearData['65+'] / totalDeaths) * 100;
    
    document.getElementById('age-bar-1').style.width = percentage1to14 + '%';
    document.getElementById('age-bar-2').style.width = percentage15to24 + '%';
    document.getElementById('age-bar-3').style.width = percentage25to44 + '%';
    document.getElementById('age-bar-4').style.width = percentage45to64 + '%';
    document.getElementById('age-bar-5').style.width = percentage65plus + '%';
    
    document.getElementById('age-label-1').innerText = `1-14 (${yearData['1-14']}人)`;
    document.getElementById('age-label-2').innerText = `15-24 (${yearData['15-24']}人)`; 
    document.getElementById('age-label-3').innerText = `25-44 (${yearData['25-44']}人)`;
    document.getElementById('age-label-4').innerText = `45-64 (${yearData['45-64']}人)`;
    document.getElementById('age-label-5').innerText = `≥65 (${yearData['65+']}人)`;
    ageDistYear.textContent = year;
  }

  // 修正 SVG 繪製函式，確保語法正確
  function drawFeature(){
    // 這部分根據你SHAP分析的結果來設定
    const labels=["年齡","高血壓","血糖","吸菸狀態"];
    // 數值為模擬的特徵重要性分數（0-100）
    const model=[95,85,60,35]; 
    // MOHW的數值為腦血管疾病在各群體中的死亡率相對高低（0-100）
    const mohw=[98,88,65,40];
     
    const svg=document.getElementById('featureSvg');
    while(svg.firstChild)svg.removeChild(svg.firstChild);
    const w=500,h=200,p=40,max=100,barH=18;

    // 圖例
    svg.innerHTML += `<rect x="80" y="8" width="10" height="10" fill="var(--accent)"/>`
    svg.innerHTML += `<text x="95" y="16" font-size="12" fill="var(--muted)">模型預測重要性</text>`
    svg.innerHTML += `<rect x="200" y="8" width="10" height="10" fill="var(--accent2)"/>`
    svg.innerHTML += `<text x="215" y="16" font-size="12" fill="var(--muted)">MOHW 統計趨勢</text>`

    labels.forEach((lb,i)=>{
      const y=p+i*(barH+16);
      svg.innerHTML+=`<text x="0" y="${y+14}" font-size="12" fill="var(--muted)">${lb}</text>`;
      const mW=(model[i]/max)*(w-150),moW=(mohw[i]/max)*(w-150);
      svg.innerHTML+=`<rect x="80" y="${y}" width="${mW}" height="${barH}" fill="var(--accent)" rx="4"/>`;
      svg.innerHTML+=`<rect x="80" y="${y+barH+4}" width="${moW}" height="${barH}" fill="var(--accent2)" rx="4"/>`;
    });
  }

  /**
   * Main initialization function.
   * Populates the year dropdown and sets up initial view.
   */
  function initialize() {
      const years = causeData.map(item => item.year).sort((a, b) => b - a);
      years.forEach(year => {
          const option = document.createElement('option');
          option.value = year;
          option.textContent = year;
          yearSelect.appendChild(option);
      });

      // Set default year to 2023
      yearSelect.value = '2023';

      // Initial display
      updateDashboard('2023');

      // Add event listener for year change
      yearSelect.addEventListener('change', (e) => {
          updateDashboard(e.target.value);
      });
  }

  /**
   * Updates all dynamic parts of the dashboard based on the selected year.
   * @param {number} year The year to display.
   */
  function updateDashboard(year) {
      updateKpiDashboard(year);
      drawTrend();
      updateGenderDistribution(year);
      updateAgeDistribution(year);
      drawFeature();
      computeRisk(); // Ensure personal risk calculation runs on load
  }

  window.onload = initialize;
</script>
</body>
</html>